variables:
  DOCKER_REGISTRY: 152370457480.dkr.ecr.eu-west-2.amazonaws.com
  AWS_DEFAULT_REGION: eu-west-2
  API_COMMON_REPOSITORY: loop-api-common
  API_REST_REPOSITORY: loop-api-rest
  DOCKER_HOST: tcp://docker:2375

default:
  services:
    - docker:dind

stages:
  - Ci_Setup
  - Lint
  - Test
  - Build_Deploy

# Stage: "CI Setup"
# ----------------------------------------------------------------------------------------------------------------------
build-api-common-ci-image:
  stage: Ci_Setup
  image:
    name: amazon/aws-cli
    entrypoint: [""]
  before_script:
    - amazon-linux-extras install docker
    - aws --version
    - docker --version
    - aws ecr get-login-password | docker login --username AWS --password-stdin $DOCKER_REGISTRY
  script:
    - docker build -t $DOCKER_REGISTRY/$API_COMMON_REPOSITORY:$CI_PIPELINE_IID -f docker/api_common/Dockerfile -t $DOCKER_REGISTRY/$API_COMMON_REPOSITORY:$CI_PIPELINE_IID .
    - docker push $DOCKER_REGISTRY/$API_COMMON_REPOSITORY:$CI_PIPELINE_IID
  rules:
    - changes:
      - docker/**/*
      - .gitlab-ci.yml
      - api.common/requirements.txt
      - api.common/**/*

# Stage: Lint
# ----------------------------------------------------------------------------------------------------------------------
lint-api-common:
  stage: Lint
  tags:
    - docker
  image: docker
  before_script:
    - aws ecr get-login-password | docker login --username AWS --password-stdin $DOCKER_REGISTRY
    - docker run -d -p 3000:3000 $DOCKER_REGISTRY/$API_COMMON_REPOSITORY:$CI_PIPELINE_IID
  script:
    - cd api.common
    - python -m pip install pycodestyle==2.8.0
    - pycodestyle --config=.pycodestyle qi
  rules:
    - changes:
      - api.common/**/*
      - .gitlab-ci.yml
