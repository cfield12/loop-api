variables:
  CI_IMAGE_PATH: registry.gitlab.com/charlie.field98/back-end
  API_COMMON_CI_IMAGE_NAME: $CI_IMAGE_PATH/api-common-ci-image

stages:
  - Ci_Setup
  - Lint
  - Test
  - Build_Deploy

# Stage: "CI Setup"
# ----------------------------------------------------------------------------------------------------------------------
build-api-common-ci-image:
  stage: Ci_Setup
  image: docker
  services:
    - docker:dind
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - docker build -t $API_COMMON_CI_IMAGE_NAME:$CI_PIPELINE_IID -f docker/api_common/Dockerfile -t $API_COMMON_CI_IMAGE_NAME:$CI_PIPELINE_IID .
    - docker push $API_COMMON_CI_IMAGE_NAME:$CI_PIPELINE_IID
  rules:
    - changes:
      - docker/**/*
      - .gitlab-ci.yml
      - api.common/requirements.txt
      - api.common/**/*

# Stage: Lint
# ----------------------------------------------------------------------------------------------------------------------
lint-api-common:
  stage: Lint
  tags:
    - docker
  image:
    name: $API_COMMON_CI_IMAGE_NAME:$CI_PIPELINE_IID
  script:
  - cd api.common
  - python -m pip install pycodestyle==2.8.0
  - pycodestyle --config=.pycodestyle qi
  rules:
    - changes:
      - api.common/**/*
      - .gitlab-ci.yml
